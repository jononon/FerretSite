<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<script src="static/js/jquery-3.1.0.min.js"></script>
	<script src="static/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
	<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
	<link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
	<link rel="shortcut icon" href="static/logos/favicon.ico" type="image/x-icon">
	<link rel="icon" href="static/logos/favicon.ico" type="image/x-icon">
	<title>Prova Console</title>
</head>
<body>
	<div class=container>
		<form>
		  <div class="form-group">
		    <label for="exampleFormControlFile1">Update CSV</label>
		    <input id="fileInput" type="file" class="form-control-file" id="exampleFormControlFile1" accept=".csv" multiple>
		  </div>
		  <div class="form-group">
		    <label for="json">Product ID</label>
		    <textarea class="form-control" id="productID" rows="1"></textarea>
		  </div>
		</form>
		<div id=output>
		</div>
		<div id=stats>
		</div>
		<canvas id="myChart" width="400" height="400"></canvas>
		<div id=orders>
			<a class="btn btn-primary" href="#" onclick="sendToUnconfirmedBackers()" role="button">Send Reminder Email to Unconfirmed Backers</a>
		</div>
	</div>
</body>
<script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDVfbz-9JfRUha9a9O6gv49Q6tdRDNS2OQ",
    authDomain: "prova-llc.firebaseapp.com",
    databaseURL: "https://prova-llc.firebaseio.com",
    projectId: "prova-llc",
    storageBucket: "",
    messagingSenderId: "970130907892"
  };
  firebase.initializeApp(config);
</script>
<script>
	firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var displayName = user.displayName;
        var email = user.email;
        var emailVerified = user.emailVerified;
        var photoURL = user.photoURL;
        var isAnonymous = user.isAnonymous;
        var uid = user.uid;
        var providerData = user.providerData;

        var invoiceRef = firebase.database().ref('/orders/');
        invoiceRef.on('value', function(snapshot) {
        var orderHTML = "<table class='table'><thead><tr><th scope='col'>Order ID</th><th scope='col'>Status</th><th scope='col'>Address</th><th scope='col'>Country</th><th scope='col'>Email</th><th scope='col'>Cart</th><th scope='col'>Action</th></tr></thead><tbody>";
          var orders = snapshot.val();
          var blueBags = 0;
          var redBags = 0;
          var blackBags = 0;
          var unconfirmedBags = 0;
          for(var order in orders) {
          	if(orders[order].status == "confirmed") {
          		orderHTML+="<tr class='table-success'>";
          	} else if(orders[order].status == undefined) {
          		orderHTML+="<tr class='table-danger'>";
          	} else if(orders[order].status == "generated") {
          		orderHTML+="<tr class='table-warning'>";
          	} else {
          		orderHTML+="<tr class='table-info'>";
          	}
          	
          	orderHTML+="<th>"+order+"</th><td>"+orders[order].status+"</td>";
          	if(orders[order].address != undefined) {
          		orderHTML+="<td><div>"+orders[order].address.thoroughfare+"</div><div>"+orders[order].address.premise+"</div><div>"+orders[order].address.city+", "+orders[order].address.state+", "+orders[order].address.zip+"</div><div>"+orders[order].address.country+"</div></td>";
          		orderHTML+="<td>"+orders[order].address.country+"</td>";
          	} else {
          		orderHTML+="<td></td>"
          		orderHTML+="<td></td>"
          	}
          	var cart = orders[order].cart;
          	var email = "";
          	if(orders[order].kickstarter != undefined) {
          		orderHTML+="<td><a href=mailto:"+orders[order].kickstarter.email+">"+orders[order].kickstarter.notes+", "+orders[order].kickstarter.email+"</a></td><td>";
          		email = orders[order].kickstarter.email;
          	} else if (orders[order].address != undefined) {
          		orderHTML+="<td><a href=mailto:"+orders[order].address.email+">"+orders[order].address.email+"</a></td><td>";
          		email = orders[order].address.email;
          	} else {
          		orderHTML+="<td></td><td>";
          	}

          	for(var item in cart) {
          		if (cart[item].productID != "KS_STICKER") {
          			if(cart[item].color==undefined) {
          				unconfirmedBags++;
          			} else if(cart[item].color == "red") {
          				redBags++;
          			} else if(cart[item].color == "blue") {
          				blueBags++;
          			} else if(cart[item].color == "black") {
          				blackBags++;
          			}

          			if(cart[item].color == undefined) {
						orderHTML+="<div style=color:grey;>"+cart[item].productID+"</div>";
	          		} else {
	          			orderHTML+="<div style=color:"+cart[item].color+";>"+cart[item].productID+"</div>";
	          		}
          		} else {
          			orderHTML+="<div>"+cart[item].productID+"</div>";
          		}
          		
          	}
          	orderHTML+="</td><td><div class='btn-group'><a href='mailto:"+email+"' role='button' class='btn btn-secondary'>Email</a><button type='button' class='btn btn-secondary dropdown-toggle dropdown-toggle-split' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><span class='sr-only'>Toggle Dropdown</span></button><div class='dropdown-menu'><a class='dropdown-item' href='#'>Action</a><a class='dropdown-item' href='#'>Another action</a><a class='dropdown-item' href='#'>Something else here</a><div class='dropdown-divider'></div><a class='dropdown-item' href='#'>Separated link</a></div></div></td></tr>";
          }
          $("#output").html(orderHTML+"</tbody></table>");
          var total = blueBags+redBags+blackBags;
          $("#stats").html("<p>Red bags: "+redBags+" ("+Math.round(redBags/total*100)+"%)</p><p>Blue bags: "+blueBags+" ("+Math.round(blueBags/total*100)+"%)</p><p>Black bags: "+blackBags+" ("+Math.round(blackBags/total*100)+"%)</p><p>Unconfirmed bags: "+unconfirmedBags+"</p>");
          var ctx = $("#myChart");
          var myPieChart = new Chart(ctx,{
			    type: 'pie',
			    data: {
			    	datasets: [{
			        	data: [redBags, blueBags, blackBags],
			        	backgroundColor: ["#ca2300","#0f00e3","#666666"]
			    	}],

			    	// These labels appear in the legend and in the tooltips when hovering different arcs
			    	labels: [
				        'Red',
				        'Blue',
				        'Black'
				    ]
				},
				options: {
			      legend: { display: false },
			      title: {
			        display: true,
			        text: 'Color Selections'
			      }
			    }
			});
        });

      } else {
        window.location.replace("login.html");
      }
    });

	var users = {};
	var inputElement = document.getElementById("fileInput");
	inputElement.addEventListener("change", handleFiles, false);
	function handleFiles() {
	  var fileList = this.files; /* now you can work with the file list */
	  for(var i = 0; i<fileList.length; i++) {
	  	var reader = new FileReader();
	  	var updateUsers
        reader.onload = function () {
        	var res = reader.result;
        	if (res.substring(0,3) === "ï»¿") {
			  res = res.substr(3);
			}
            var lines = res.split('\n');
            var terms = lines[0].toLowerCase().replace(/\s/g,'').split(',');
            terms[4] = "shippingCountry";
            for(var j = 1; j<lines.length; j++) {
            	var elements = lines[j].split(',');
            	var user = {};
            	for(var k = 0; k<elements.length; k++) {
            		user[terms[k]] = elements[k];
            	}
            	user["shippingSurcharge"] = parseFloat(String(elements[5]).substring(1));
            	user["pledgeAmount"] = parseFloat(String(elements[9]).substring(1));
            	user["backerNumber"] = parseInt(elements[0]);
            	// console.log(JSON.stringify(user));
            	users[String(elements[1])] = user;
            	firebase.database().ref("/orders/"+elements[1]+"/kickstarter/").set(user);
            	for(var l = 0; l<parseInt(elements[16]); l++) {
            		firebase.database().ref("/orders/"+elements[1]+"/cart/").push({"productID":$("#productID").val()});
            	}
            }
        };
        reader.readAsBinaryString(fileInput.files[i]);
	  }
	  console.log(users);
	}


	function sendToUnconfirmedBackers() {
		return firebase.database().ref("/orders/").once('value').then(function(snapshot) {
			var val = snapshot.val();
			var emailData = {
				template_id : "d-a28818b6a5864a3fbd8f025a6213b205",
				from : {
			      email : "hello@provadesign.com",
			      name : "Prova Design"
			    },
			    personalizations : []
			}
			for(orderId in val) {
				var order = val[orderId];
				if(order.kickstarter != undefined && order.cart != undefined) {
					if(order.kickstarter.notes == "collected" && order.kickstarter.numbags == "yes" && order.kickstarter.email != "" && order.kickstarter.email != undefined) {
						for(item in order.cart) {
							if (order.cart[item].color == undefined) {
								
								emailData.personalizations.push({
							      dynamic_template_data : {
							        orderID : orderId
							      },
							      to : [ {
							        email : order.kickstarter.email
							      }]
							  	});
								break;
							}
						}
					}
				}
			}
			console.log(emailData);
			var sendEmails = firebase.functions().httpsCallable('sendEmails');
			sendEmails({request: emailData}).then(function(result) {
				console.log(result.data);
			});
		});
	}

	// var ordersRef = firebase.database().ref('/orders/');
 //        ordersRef.on('value', function(snapshot) {
 //        	var val = snapshot.val();
 //        	var ordersTable = "<table class='table'><thead><tr><th scope='col'>orderNumber</th><th scope='col'>email</th><th scope='col'>status</th><th scope='col'>paid</th><th scope='col'>paymentId</th></tr></thead><tbody>";
 //        	for(charge in val) {
	//         	chargesTable+="<tr><td>"+val[charge].userId+"</td><td>"+val[charge].deviceId+"</td><td>"+val[charge].startTime+"</td><td>"+val[charge].duration+"</td><td>"+val[charge].paymentId+"</td></tr>";
 //        	}
 //        	chargesTable += "</tbody></table>";
 //        	$("#charges").html(chargesTable);
 //        });
</script>
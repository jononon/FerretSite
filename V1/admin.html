<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<script src="static/js/jquery-3.1.0.min.js"></script>
	<script src="static/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
	<link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
	<link rel="shortcut icon" href="static/logos/favicon.ico" type="image/x-icon">
	<link rel="icon" href="static/logos/favicon.ico" type="image/x-icon">
	<title>Prova Console</title>
</head>
<body>
	<div class=container>
		<form>
		  <div class="form-group">
		    <label for="exampleFormControlFile1">Update CSV</label>
		    <input id="fileInput" type="file" class="form-control-file" id="exampleFormControlFile1" accept=".csv" multiple>
		  </div>
		  <div class="form-group">
		    <label for="json">Product ID</label>
		    <textarea class="form-control" id="productID" rows="1"></textarea>
		  </div>
		</form>
		<div id=output>
		</div>

		<div id=stats>
		</div>
	</div>
</body>
<script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDVfbz-9JfRUha9a9O6gv49Q6tdRDNS2OQ",
    authDomain: "prova-llc.firebaseapp.com",
    databaseURL: "https://prova-llc.firebaseio.com",
    projectId: "prova-llc",
    storageBucket: "",
    messagingSenderId: "970130907892"
  };
  firebase.initializeApp(config);
</script>
<script>

	firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var displayName = user.displayName;
        var email = user.email;
        var emailVerified = user.emailVerified;
        var photoURL = user.photoURL;
        var isAnonymous = user.isAnonymous;
        var uid = user.uid;
        var providerData = user.providerData;

        var invoiceRef = firebase.database().ref('/orders/');
        invoiceRef.on('value', function(snapshot) {
          var orders = snapshot.val();
          var blueBags = 0;
          var redBags = 0;
          var blackBags = 0;
          var unconfirmedBags = 0;
          for(var order in orders) {
          	var cart = orders[order].cart;
          	for(var item in cart) {
          		if (cart[item].productID != "KS_STICKER") {
          			if(cart[item].color==undefined) {
          				unconfirmedBags++;
          			} else if(cart[item].color == "red") {
          				redBags++;
          			} else if(cart[item].color == "blue") {
          				blueBags++;
          			} else if(cart[item].color == "black") {
          				blackBags++;
          			}
          		}
          	}
          }
          $("#stats").html("<p>Red bags: "+redBags+"</p><p>Blue bags: "+blueBags+"</p><p>Black bags: "+blackBags+"</p><p>Unconfirmed bags: "+unconfirmedBags+"</p>");
        });

      } else {
        window.location.replace("login.html");
      }
    });

	var users = {};
	var inputElement = document.getElementById("fileInput");
	inputElement.addEventListener("change", handleFiles, false);
	function handleFiles() {
	  var fileList = this.files; /* now you can work with the file list */
	  for(var i = 0; i<fileList.length; i++) {
	  	var reader = new FileReader();
	  	var updateUsers
        reader.onload = function () {
        	var res = reader.result;
        	if (res.substring(0,3) === "ï»¿") {
			  res = res.substr(3);
			}
            var lines = res.split('\n');
            var terms = lines[0].toLowerCase().replace(/\s/g,'').split(',');
            terms[4] = "shippingCountry";
            for(var j = 1; j<lines.length; j++) {
            	var elements = lines[j].split(',');
            	var user = {};
            	for(var k = 0; k<elements.length; k++) {
            		user[terms[k]] = elements[k];
            	}
            	user["shippingSurcharge"] = parseFloat(String(elements[5]).substring(1));
            	user["pledgeAmount"] = parseFloat(String(elements[9]).substring(1));
            	user["backerNumber"] = parseInt(elements[0]);
            	// console.log(JSON.stringify(user));
            	users[String(elements[1])] = user;
            	firebase.database().ref("/orders/"+elements[1]+"/kickstarter/").set(user);
            	for(var l = 0; l<parseInt(elements[16]); l++) {
            		firebase.database().ref("/orders/"+elements[1]+"/cart/").push({"productID":$("#productID").val()});
            	}
            }
        };
        reader.readAsBinaryString(fileInput.files[i]);
	  }
	  console.log(users);
	}
</script>
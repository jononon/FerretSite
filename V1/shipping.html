<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<script src="static/js/jquery-3.1.0.min.js"></script>
	<script src="static/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
	<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
	<link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
	<link rel="shortcut icon" href="static/logos/favicon.ico" type="image/x-icon">
	<link rel="icon" href="static/logos/favicon.ico" type="image/x-icon">
	<title>Prova Console</title>
</head>
<body>
	<div class=container id=main>

	</div>
</body>
<script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDVfbz-9JfRUha9a9O6gv49Q6tdRDNS2OQ",
    authDomain: "prova-llc.firebaseapp.com",
    databaseURL: "https://prova-llc.firebaseio.com",
    projectId: "prova-llc",
    storageBucket: "",
    messagingSenderId: "970130907892"
  };
  firebase.initializeApp(config);
</script>
<script>
	function gup (name) {
		name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
		var regexS = "[\\?&]"+name+"=([^&#]*)";
		var regex = new RegExp(regexS);
		var results = regex.exec(window.location.href);
		if (results == null) {
			return '';
		} else {
			return results[1];
		}
	} // gup() - Get URL Param

	function generateUPSRates(orderId) {
		var func = firebase.functions().httpsCallable('generateUPSRates')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
			$("$#columns").append("<div class='card' style='width: 18rem;'><h5 class='card-header'>UPS</h5><ul class='list-group list-group-flush'><li class='list-group-item'><h6 class='card-title'>Linted Address</h6><p class='card-text'>Jonathan Damico<br>1124 Napoli Drive<br>Pacific Palisades, CA 90272</p></li><li class='list-group-item'><h6 class='card-title'>Cost</h6><p class='card-text'>$6.55</p><a href='#' class='btn btn-primary'>Refresh</a></li></ul><div class='card-body'><a href='#' class='btn btn-primary'>Ship</a></div></div>");
		});
	}

	function generateUPSSticker(orderId) {
		var func = firebase.functions().httpsCallable('generateUPSSticker')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
			$("$#columns").append("<div class='card' style='width: 18rem;'><h5 class='card-header'>UPS</h5><ul class='list-group list-group-flush'><li class='list-group-item'><h6 class='card-title'>Linted Address</h6><p class='card-text'>Jonathan Damico<br>1124 Napoli Drive<br>Pacific Palisades, CA 90272</p></li><li class='list-group-item'><h6 class='card-title'>Cost</h6><p class='card-text'>$6.55</p><a href='#' class='btn btn-primary'>Refresh</a></li></ul><div class='card-body'><a href='#' class='btn btn-primary'>Ship</a></div></div>");
		});
	}

	function generateUSPSRates(orderId) {
		var func = firebase.functions().httpsCallable('generateUSPSRates')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
		});
	}

	function generateUSPSIntlRates(orderId) {
		var func = firebase.functions().httpsCallable('generateUSPSIntlRates')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
		});
	}

	var numBagsArr = [];
	var countriesArr = [];
	firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var displayName = user.displayName;
        var email = user.email;
        var emailVerified = user.emailVerified;
        var photoURL = user.photoURL;
        var isAnonymous = user.isAnonymous;
        var uid = user.uid;
        var providerData = user.providerData;

        var orderNumber = gup("orderNumber");


        var csv = "Order Number,Value,Description,Length,Width,Height,Weight,Name,Address 1,Address 2,City,State,Postal Code,Country,Email,Rubber Stamp\r\n";

        var laZIPs = ["90895","91001","91006","91007","91011","91010","91016","91020","91017","93510","91023","91024","91030","91040","91043","91042","91101","91103","91105","93534","91104","93532","91107","93536","91106","93535","91108","93539","93543","93544","91123","93551","93550","93553","93552","91182","93563","93590","91189","91202","91201","93591","91204","91203","91206","91205","91208","91207","91210","91214","91302","91301","91304","91303","91306","91307","91310","92397","91311","91316","91321","91325","91324","91326","91331","91330","91335","91340","91343","91342","91345","91344","91350","91346","91352","91351","91354","91356","91355","91357","91361","91364","91367","91365","91381","91383","91384","91387","91390","91402","91401","91403","91406","91405","91411","91423","91436","91495","91501","91502","91505","91504","91506","91602","91601","91604","91606","91605","91608","91607","91614","91618","91706","91702","91711","91722","91724","91723","91732","91731","91733","91735","91740","91741","91745","91744","91747","91746","91748","90002","91750","90001","90004","91755","91754","90003","90006","90005","90008","91759","90007","90010","90012","91765","90011","90014","91767","91766","90013","90016","91768","90015","90018","90017","91770","91773","90020","91772","90019","91776","90022","90021","91775","91780","90024","91778","90023","90026","90025","90028","90027","91790","90029","91789","90032","91792","91791","90031","90034","91793","90033","90036","90035","91801","90038","90037","90040","91803","90039","90042","90041","90044","90043","90046","90045","90048","90047","90049","90052","90056","90058","90057","90060","90059","90062","90061","90064","90063","90066","90065","90068","90067","90069","90071","90074","90077","91008","90084","90089","90095","90094","90096","90201","90189","90211","90210","90212","90221","90220","90222","90230","90232","90241","90240","90245","90242","90248","90247","90250","90249","90254","90260","90255","90262","90264","90263","90266","90265","90270","90274","90272","90277","90275","90280","90278","90291","90290","90293","90292","90295","90301","90296","90303","90302","90305","90304","90402","90401","90404","90403","90406","93243","90405","90501","90503","90502","90505","90504","90508","90601","90603","90602","90605","90604","90606","90631","90639","90638","90650","90640","90660","90670","90702","90701","90704","90703","90706","90710","90713","90712","90715","90717","90716","90731","90723","90733","90732","90745","90744","90747","90746","90755","90803","90802","90805","90804","90807","90806","90808","90813","90810","90815","90814","90840","90042","90403","90404","90401","90405"];

        var invoiceRef = firebase.database().ref('/orders/');
        invoiceRef.once('value').then(function(snapshot) {
        	var orders = snapshot.val()
       		for(var order in orders) {
       			if(orders[order].status == "confirmed") {
       				var numBlue = 0;
       				var numRed = 0;
       				var numBlack = 0;
       				for (var item in orders[order].cart) {
       					if(orders[order].cart[item].productID != "KS_STICKER") {
       						if(orders[order].cart[item].color == "black") {
       							numBlack++;
       						} else if (orders[order].cart[item].color == "blue") {
       							numBlue++;
       						} else if (orders[order].cart[item].color == "red") {
       							numRed++;
       						}
       					}
       				}
       				var height = (numBlue+numRed+numBlack)>2?6:3;
       				var rubberStamp = "";
       				if(numBlue>0) { rubberStamp+= ""+numBlue+"xBlue "; }
       				if(numBlack>0) { rubberStamp+= ""+numBlack+"xBlack "; }
       				if(numRed>0) { rubberStamp+= ""+numRed+"xRed "; }
       				var weight = 2*16*(numBlue+numBlack+numRed)
       				var fields = [order, 20*(numRed+numBlue+numBlack), "Backpacks", 19, 12, height, weight, orders[order].address.name,orders[order].address.thoroughfare,orders[order].address.premise,orders[order].address.city,orders[order].address.state,orders[order].address.zip,orders[order].address.country,orders[order].address.email,rubberStamp];

       				var inLA = false;
       				for (zip in laZIPs) {
       					if(orders[order].address.zip == zip) {
       						inLA = true;
       					}
       				}
       				if(!inLA) {
       					csv+="\""+fields.join("\",\"")+"\"\r\n";
       				}
       			}
       		}
       		$("#main").html(csv);
       		let csvContent = "data:text/csv;charset=utf-8,"+csv;
       		var encodedUri = encodeURI(csvContent);
			window.open(encodedUri);
        });

      } else {
        window.location.replace("login.html");
      }
    });
</script>
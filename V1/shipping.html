<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<script src="static/js/jquery-3.1.0.min.js"></script>
	<script src="static/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
	<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
	<link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
	<link rel="shortcut icon" href="static/logos/favicon.ico" type="image/x-icon">
	<link rel="icon" href="static/logos/favicon.ico" type="image/x-icon">
	<title>Prova Console</title>
</head>
<body>
	<div class=container id=main>

	</div>
</body>
<script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDVfbz-9JfRUha9a9O6gv49Q6tdRDNS2OQ",
    authDomain: "prova-llc.firebaseapp.com",
    databaseURL: "https://prova-llc.firebaseio.com",
    projectId: "prova-llc",
    storageBucket: "",
    messagingSenderId: "970130907892"
  };
  firebase.initializeApp(config);
</script>
<script>
	function gup (name) {
		name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
		var regexS = "[\\?&]"+name+"=([^&#]*)";
		var regex = new RegExp(regexS);
		var results = regex.exec(window.location.href);
		if (results == null) {
			return '';
		} else {
			return results[1];
		}
	} // gup() - Get URL Param

	function generateUPSRates(orderId) {
		var func = firebase.functions().httpsCallable('generateUPSRates')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
			$("$#columns").append("<div class='card' style='width: 18rem;'><h5 class='card-header'>UPS</h5><ul class='list-group list-group-flush'><li class='list-group-item'><h6 class='card-title'>Linted Address</h6><p class='card-text'>Jonathan Damico<br>1124 Napoli Drive<br>Pacific Palisades, CA 90272</p></li><li class='list-group-item'><h6 class='card-title'>Cost</h6><p class='card-text'>$6.55</p><a href='#' class='btn btn-primary'>Refresh</a></li></ul><div class='card-body'><a href='#' class='btn btn-primary'>Ship</a></div></div>");
		});
	}

	function generateUPSSticker(orderId) {
		var func = firebase.functions().httpsCallable('generateUPSSticker')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
			$("$#columns").append("<div class='card' style='width: 18rem;'><h5 class='card-header'>UPS</h5><ul class='list-group list-group-flush'><li class='list-group-item'><h6 class='card-title'>Linted Address</h6><p class='card-text'>Jonathan Damico<br>1124 Napoli Drive<br>Pacific Palisades, CA 90272</p></li><li class='list-group-item'><h6 class='card-title'>Cost</h6><p class='card-text'>$6.55</p><a href='#' class='btn btn-primary'>Refresh</a></li></ul><div class='card-body'><a href='#' class='btn btn-primary'>Ship</a></div></div>");
		});
	}

	function generateUSPSRates(orderId) {
		var func = firebase.functions().httpsCallable('generateUSPSRates')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
		});
	}

	function generateUSPSIntlRates(orderId) {
		var func = firebase.functions().httpsCallable('generateUSPSIntlRates')
		func({orderId:orderId}).then(function(result) {
			console.log(result.data);
		});
	}

	var numBagsArr = [];
	var countriesArr = [];
	firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var displayName = user.displayName;
        var email = user.email;
        var emailVerified = user.emailVerified;
        var photoURL = user.photoURL;
        var isAnonymous = user.isAnonymous;
        var uid = user.uid;
        var providerData = user.providerData;

        var orderNumber = gup("orderNumber");


        var csv = "Order Number,Value,Description,Length,Width,Height,Weight,Name,Address 1,Address 2,City,State,Postal Code,Country,Email,Rubber Stamp\r\n";

        var invoiceRef = firebase.database().ref('/orders/');
        invoiceRef.on('value', function(snapshot) {
        	var orders = snapshot.val()
       		for(var order in orders) {
       			if(orders[order].status == "confirmed") {
       				var numBlue = 0;
       				var numRed = 0;
       				var numBlack = 0;
       				for (var item in orders[order].cart) {
       					if(orders[order].cart[item].productID != "KS_STICKER") {
       						if(orders[order].cart[item].color == "black") {
       							numBlack++;
       						} else if (orders[order].cart[item].color == "blue") {
       							numBlue++;
       						} else if (orders[order].cart[item].color == "red") {
       							numRed++;
       						}
       					}
       				}
       				var height = (numBlue+numRed+numBlack)>2?6:3;
       				var rubberStamp = "";
       				if(numBlue>0) { rubberStamp+= ""+numBlue+"xBlue "; }
       				if(numBlack>0) { rubberStamp+= ""+numBlack+"xBlack "; }
       				if(numRed>0) { rubberStamp+= ""+numRed+"xRed "; }
       				var weight = 16*(numBlue+numBlack+numRed)
       				var fields = [order, 20*(numRed+numBlue+numBlack), "Backpacks", 19, 12, height, weight, orders[order].address.name,orders[order].address.thoroughfare,orders[order].address.premise,orders[order].address.city,orders[order].address.state,orders[order].address.zip,orders[order].address.country,orders[order].address.email,rubberStamp];
       				csv+="\""+fields.join("\",\"")+"\"\r\n";
       			}
       		}
       		$("#main").html(csv);
       		let csvContent = "data:text/csv;charset=utf-8,"+csv;
       		var encodedUri = encodeURI(csvContent);
			window.open(encodedUri);
        });

      } else {
        window.location.replace("login.html");
      }
    });

</script>